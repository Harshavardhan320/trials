name: Performance File Validator

on:
  push:
    branches:
      - "**"

jobs:
  validate:
    runs-on: ubuntu-latest

    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
      TELEGRAM_API:       ${{ secrets.TELEGRAM_API }}

    steps:
      # --------------------------------------------------
      # 1. Checkout
      # --------------------------------------------------
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # 2. Detect relevant folder changes
      # --------------------------------------------------
      - name: Detect folder changes
        id: detect
        run: |
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            FILES=$(git diff --name-only HEAD~1 HEAD)
          else
            FILES=$(git diff --name-only)
          fi

          echo "$FILES"

          RUN=false
          for f in dailyPerformance weeklyPerformance monthlyPerformance yearlyPerformance; do
            if echo "$FILES" | grep -q "^$f/"; then
              RUN=true
              break
            fi
          done

          echo "run=$RUN" >> $GITHUB_OUTPUT

      # --------------------------------------------------
      # 3. Stop early if no folder touched
      # --------------------------------------------------
      - name: Stop – no relevant changes
        if: steps.detect.outputs.run == 'false'
        run: |
          echo "No performance folders touched. Workflow stopped."
          exit 0

      # --------------------------------------------------
      # 4. Block if PR exists touching folders
      # --------------------------------------------------
      - name: Block if PR exists
        run: |
          python3 << 'EOF'
          import requests, os, sys

          repo = os.environ["GITHUB_REPOSITORY"]
          token = os.environ["GITHUB_TOKEN"]
          headers = {"Authorization": f"Bearer {token}"}

          prs = requests.get(
            f"https://api.github.com/repos/{repo}/pulls?state=open",
            headers=headers
          ).json()

          folders = ["dailyPerformance","weeklyPerformance","monthlyPerformance","yearlyPerformance"]

          for pr in prs:
            files = requests.get(pr["url"] + "/files", headers=headers).json()
            for f in files:
              for folder in folders:
                if f["filename"].startswith(folder + "/"):
                  msg = "❌ Commit rejected — Existing PR touches performance folders"
                  requests.post(
                    os.environ["TELEGRAM_API"] + os.environ["TELEGRAM_BOT_TOKEN"] + "/sendMessage",
                    data={"chat_id": os.environ["TELEGRAM_CHAT_ID"], "text": msg}
                  )
                  sys.exit(0)
          EOF

      # --------------------------------------------------
      # 5. Validate & Rename using Python
      # --------------------------------------------------
      - name: Validate and rename files
        id: rename
        run: |
          python3 << 'EOF'
          import os, re, sys, datetime, calendar, subprocess

          ROOT = os.getcwd()
          FOLDERS = {
            "dailyPerformance": "day",
            "weeklyPerformance": "week",
            "monthlyPerformance": "month",
            "yearlyPerformance": "year"
          }

          today = datetime.date.today()
          weekday = today.weekday()  # Mon=0

          renamed = []

          for folder, typ in FOLDERS.items():
            path = os.path.join(ROOT, folder)
            files = [f for f in os.listdir(path) if f.endswith(".csv")]

            # highest serial
            serials = []
            for f in files:
              m = re.match(r"(\d+)\s", f)
              if m:
                serials.append(int(m.group(1)))
            next_serial = max(serials, default=0) + 1

            for f in files:
              if f == "holdings.csv":
                if typ == "day" and weekday >= 5:
                  raise SystemExit("Daily holdings not allowed on weekend")

                year = today.year
                month = today.strftime("%b")

                if typ == "day":
                  period = f"{today.day}_day"
                elif typ == "week":
                  week = (today.day - 1) // 5 + 1
                  period = f"{week}_week"
                elif typ == "month":
                  period = f"{today.month}_month"
                else:
                  period = "1_year"

                new_name = f"{next_serial} {year} {period} {month}.csv"

              else:
                if re.match(r"\d+\s\d{4}\s", f):
                  continue  # already proper
                year, rest = f.split(" ", 1)
                new_name = f"{next_serial} {year} {rest}"

              old = os.path.join(path, f)
              new = os.path.join(path, new_name)

              if os.path.exists(new):
                raise SystemExit(f"Duplicate filename: {new_name}")

              os.rename(old, new)
              renamed.append(f"{folder}/{new_name}")
              next_serial += 1

          if renamed:
            subprocess.run(["git", "add", "-A"])
            msg = ", ".join(renamed)
            subprocess.run(["git", "commit", "-m", f"{msg} + Updated + {today.strftime('%d/%m/%Y')}"])
            subprocess.run(["git", "push"])

          print("Renamed:", renamed)
          EOF

      # --------------------------------------------------
      # 6. Telegram success
      # --------------------------------------------------
      - name: Telegram success
        if: success()
        run: |
          curl -s -X POST "$TELEGRAM_API$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="✅ Validation success — Files renamed and committed"
