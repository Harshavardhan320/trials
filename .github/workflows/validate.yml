name: FunStock Validator

on:
  push:
    branches:
      - "**"

jobs:
  validate:
    runs-on: ubuntu-latest

    env:
      TARGET_FOLDERS: "daily weekly monthly yearly"
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
      TELEGRAM_API:       ${{ secrets.TELEGRAM_API }}

    steps:

      # ---------------------------------------------------------
      # 1) CHECKOUT CODE
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # ---------------------------------------------------------
      # 2) DETECT CHANGES IN TARGET FOLDERS
      # ---------------------------------------------------------
      - name: Detect changes in target folders
        id: changes
        run: |
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          else
            CHANGED_FILES=$(git diff --name-only --cached)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          SHOULD_RUN="false"
          for folder in $TARGET_FOLDERS; do
            if echo "$CHANGED_FILES" | grep -q "^${folder}/"; then
              SHOULD_RUN="true"
              break
            fi
          done

          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      # 3) STOP WORKFLOW IF NO TARGET FOLDER CHANGES (IMPORTANT)
      # ---------------------------------------------------------
      - name: Stop workflow — No relevant folder changes
        if: steps.changes.outputs.should_run == 'false'
        run: |
          echo "No daily/weekly/monthly/yearly folder changes — workflow stopped."
          exit 1

      # ---------------------------------------------------------
      # 4) CHECK IF ANY PR TOUCHES 4 FOLDERS
      # ---------------------------------------------------------
      - name: Check PR existence for target folders
        id: prcheck
        if: steps.changes.outputs.should_run == 'true'
        run: |
          REPO="${{ github.repository }}"
          PR_LIST=$(curl -sS \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/pulls?state=open")

          HAS_PR="false"

          for pr in $(echo "$PR_LIST" | jq -r '.[].number'); do

            FILES=$(curl -sS \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/pulls/$pr/files" | jq -r '.[].filename')

            for folder in daily weekly monthly yearly; do
              if echo "$FILES" | grep -q "^${folder}/"; then
                HAS_PR="true"
                break 2
              fi
            done
          done

          echo "has_pr=$HAS_PR" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      # 5) PR EXISTS → SEND TELEGRAM + STOP WORKFLOW
      # ---------------------------------------------------------
      - name: Telegram — PR exists (stop workflow)
        if: steps.prcheck.outputs.has_pr == 'true'
        run: |
          MSG="❌ Commit rejected — An open PR already modifies daily/weekly/monthly/yearly folders."
          curl -s -X POST "$TELEGRAM_API$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MSG"
          exit 1

      # ---------------------------------------------------------
      # 6) SETUP JAVA
      # ---------------------------------------------------------
      - name: Set up Java
        if: steps.changes.outputs.should_run == 'true'
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      # ---------------------------------------------------------
      # 7) BUILD VALIDATOR
      # ---------------------------------------------------------
      - name: Build validator
        if: steps.changes.outputs.should_run == 'true'
        working-directory: ./commit-engine-file-rename
        run: mvn -q -DskipTests package

      # ---------------------------------------------------------
      # 8) RUN VALIDATOR
      # ---------------------------------------------------------
      - name: Run validator
        id: validate
        if: steps.changes.outputs.should_run == 'true'
        working-directory: ./commit-engine-file-rename
        run: |
          set +e
          java -cp "target/classes:target/commit-engine-file-rename-1.0-SNAPSHOT.jar" java.com.fsm.validator.Main \
            > validator.log 2>&1
          
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          echo "log<<EOF" >> $GITHUB_OUTPUT
          cat validator.log >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          exit 0

      # ---------------------------------------------------------
      # 9) VALIDATION FAILURE
      # ---------------------------------------------------------
      - name: Telegram — Validation failed
        if: steps.validate.outputs.exit_code != '0'
        run: |
          ERR=$(echo "${{ steps.validate.outputs.log }}" | head -n 1)
          MSG="❌ Commit rejected — Validation failed: $ERR"
          
          curl -s -X POST "$TELEGRAM_API$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MSG"

          exit 1

      # ---------------------------------------------------------
      # 10) VALIDATION SUCCESS
      # ---------------------------------------------------------
      - name: Telegram — Validation success
        if: steps.validate.outputs.exit_code == '0'
        run: |
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            FILES=$(git diff --name-only HEAD~1 HEAD | paste -sd "," -)
          else
            FILES=$(git diff --name-only --cached | paste -sd "," -)
          fi

          MSG="✅ Validation success — Files updated successfully: $FILES"
          
          curl -s -X POST "$TELEGRAM_API$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MSG"

      # ---------------------------------------------------------
      # 11) AUTO COMMIT RENAMED FILES
      # ---------------------------------------------------------
      - name: Auto-commit renamed files
        if: steps.validate.outputs.exit_code == '0'
        run: |
          git config user.email "github-actions@github.com"
          git config user.name  "GitHub Actions Bot"

          git add -A

          if git diff-index --quiet HEAD; then
            echo "No renamed files to commit."
          else
            DATE=$(date +"%d/%m/%Y")
            FILES=$(git diff --name-only --cached | paste -sd "," -)
            MSG="$FILES + Updated + $DATE"
            git commit -m "$MSG"
            git push
          fi
