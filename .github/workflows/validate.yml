name: Commit Engine – File Rename & Validation

on:
  push:
    branches:
      - "**"

jobs:
  rename-and-validate:
    runs-on: ubuntu-latest

    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID:  ${{ secrets.TELEGRAM_CHAT_ID }}
      TELEGRAM_API:      ${{ secrets.TELEGRAM_API }}

    steps:
      # -------------------------------------------------------
      # 1. Checkout repository
      # -------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # -------------------------------------------------------
      # 2. Run validation + rename engine
      # -------------------------------------------------------
      - name: Validate & Rename CSV Files
        run: |
          python3 << 'EOF'
          import os, re, sys, datetime, subprocess, requests

          today = datetime.date.today()
          weekday = today.weekday()  # Mon=0
          date_str = today.strftime("%d-%b-%Y")

          folders = {
            "dailyPerformance": "day",
            "weeklyPerformance": "week",
            "monthlyPerformance": "month",
            "yearlyPerformance": "year"
          }

          renamed = []

          def send(msg):
              requests.post(
                  os.environ["TELEGRAM_API"] +
                  os.environ["TELEGRAM_BOT_TOKEN"] +
                  "/sendMessage",
                  data={
                      "chat_id": os.environ["TELEGRAM_CHAT_ID"],
                      "text": msg
                  }
              )

          def fail(folder, file, reason):
              send(
                  f"❌ COMMIT REJECTED\n\n"
                  f"Folder: {folder}\n"
                  f"File: {file}\n"
                  f"Date: {date_str}\n\n"
                  f"Reason:\n{reason}"
              )
              sys.exit(1)

          for folder, ftype in folders.items():

              if not os.path.isdir(folder):
                  continue

              files = [f for f in os.listdir(folder) if f.endswith(".csv")]

              # highest serial in folder
              serials = []
              for f in files:
                  m = re.match(r"(\d+)\s", f)
                  if m:
                      serials.append(int(m.group(1)))

              next_serial = max(serials, default=0) + 1
              periods_seen = set()

              for f in files:
                  full = os.path.join(folder, f)

                  # ---------------- HOLDINGS ----------------
                  if f.lower() == "holdings.csv":

                      if ftype == "day" and weekday >= 5:
                          fail(folder, f, "Daily holdings not allowed on weekends")

                      year = today.year
                      month = today.strftime("%b")

                      if ftype == "day":
                          period = f"{today.day}_day"
                      elif ftype == "week":
                          period = f"{(today.day - 1)//5 + 1}_week"
                      elif ftype == "month":
                          period = f"{today.month}_month"
                      else:
                          period = "1_year"

                  # ---------------- MISSING FILE ----------------
                  elif re.match(r"\d{4}\s", f):
                      parts = f.replace(".csv", "").split()
                      if len(parts) != 3:
                          fail(folder, f, "Invalid missing file format")

                      year, period, month = parts

                  # ---------------- ALREADY VALID ----------------
                  elif re.match(r"\d+\s\d{4}\s", f):
                      continue

                  # ---------------- INVALID ----------------
                  else:
                      fail(folder, f, "Invalid filename format")

                  key = f"{year}_{period}_{month}"
                  if key in periods_seen:
                      fail(folder, f, "Duplicate time period detected")

                  periods_seen.add(key)

                  new_name = f"{next_serial} {year} {period} {month}.csv"
                  new_path = os.path.join(folder, new_name)

                  if os.path.exists(new_path):
                      fail(folder, new_name, "Duplicate final filename")

                  os.rename(full, new_path)
                  renamed.append(f"{folder}/{new_name}")
                  next_serial += 1

          if renamed:
              subprocess.run(["git", "add", "-A"])
              subprocess.run([
                  "git", "commit",
                  "-m", f"{', '.join(renamed)} + Updated + {today.strftime('%d/%m/%Y')}"
              ])
              subprocess.run(["git", "push"])

              send(
                  f"✅ COMMIT SUCCESSFUL\n\n"
                  f"Date: {date_str}\n\n"
                  f"Files processed:\n" +
                  "\n".join(renamed)
              )
          EOF
