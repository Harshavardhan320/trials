name: Performance File Validator & Renamer

on:
  push:
    branches:
      - "**"

jobs:
  validate:
    runs-on: ubuntu-latest

    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
      TELEGRAM_API:       ${{ secrets.TELEGRAM_API }}

    steps:
      # --------------------------------------------------
      # 1️⃣ CHECKOUT CODE
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # 2️⃣ DETECT IF ANY PERFORMANCE FOLDER IS TOUCHED
      # --------------------------------------------------
      - name: Detect relevant folder changes
        id: detect
        run: |
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            FILES=$(git diff --name-only HEAD~1 HEAD)
          else
            FILES=$(git diff --name-only --cached)
          fi

          echo "$FILES"

          RUN="false"
          for f in dailyPerformance weeklyPerformance monthlyPerformance yearlyPerformance; do
            if echo "$FILES" | grep -q "^$f/"; then
              RUN="true"
              break
            fi
          done

          echo "run=$RUN" >> $GITHUB_OUTPUT

      # --------------------------------------------------
      # 3️⃣ IF NOT RELATED → STOP COMPLETELY
      # --------------------------------------------------
      - name: Skip workflow (no performance folders)
        if: steps.detect.outputs.run == 'false'
        run: |
          echo "No performance folder touched. Workflow stopped."
          exit 0

      # --------------------------------------------------
      # 4️⃣ BLOCK IF PR EXISTS FOR ANY PERFORMANCE FOLDER
      # --------------------------------------------------
      - name: Block if PR exists
        run: |
          python3 << 'EOF'
          import requests, os, sys

          repo = os.environ["GITHUB_REPOSITORY"]
          token = os.environ["GITHUB_TOKEN"]

          headers = {
            "Authorization": f"Bearer {token}",
            "Accept": "application/vnd.github+json"
          }

          folders = [
            "dailyPerformance/",
            "weeklyPerformance/",
            "monthlyPerformance/",
            "yearlyPerformance/"
          ]

          prs = requests.get(
            f"https://api.github.com/repos/{repo}/pulls?state=open",
            headers=headers
          ).json()

          for pr in prs:
            files = requests.get(pr["url"] + "/files", headers=headers).json()
            for f in files:
              for folder in folders:
                if f["filename"].startswith(folder):
                  msg = (
                    "❌ COMMIT REJECTED — EXISTING PR FOUND\n\n"
                    "Another Pull Request already modifies performance folders.\n"
                    "Please merge or close it before committing new files."
                  )
                  requests.post(
                    os.environ["TELEGRAM_API"] + os.environ["TELEGRAM_BOT_TOKEN"] + "/sendMessage",
                    data={"chat_id": os.environ["TELEGRAM_CHAT_ID"], "text": msg}
                  )
                  sys.exit(0)
          EOF
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --------------------------------------------------
      # 5️⃣ VALIDATION + RENAME + SERIAL ASSIGNMENT
      # --------------------------------------------------
      - name: Validate, rename & assign serial numbers
        run: |
          python3 << 'EOF'
          import os, re, datetime, subprocess, sys, requests

          today = datetime.date.today()
          weekday = today.weekday()  # Mon=0
          date_str = today.strftime("%d-%b-%Y")

          folders = {
            "dailyPerformance": "day",
            "weeklyPerformance": "week",
            "monthlyPerformance": "month",
            "yearlyPerformance": "year"
          }

          renamed = []

          def fail(msg):
            requests.post(
              os.environ["TELEGRAM_API"] + os.environ["TELEGRAM_BOT_TOKEN"] + "/sendMessage",
              data={"chat_id": os.environ["TELEGRAM_CHAT_ID"], "text": msg}
            )
            sys.exit(1)

          for folder, ftype in folders.items():
            path = folder
            files = [f for f in os.listdir(path) if f.endswith(".csv")]

            # collect serials
            serials = []
            for f in files:
              m = re.match(r"(\\d+)\\s", f)
              if m:
                serials.append(int(m.group(1)))

            next_serial = max(serials, default=0) + 1

            periods_seen = set()

            for f in files:
              full = os.path.join(path, f)

              # INVALID EXTENSION
              if not f.endswith(".csv"):
                fail(f"❌ INVALID FILE EXTENSION\n\nFolder: {folder}\nFile: {f}")

              # HOLDINGS
              if f.lower() == "holdings.csv":
                if ftype == "day" and weekday >= 5:
                  fail(
                    f"❌ DAILY HOLDINGS UPLOAD BLOCKED\n\n"
                    f"Folder: {folder}\n"
                    f"Date: {date_str}\n"
                    f"Reason: Weekend uploads are not allowed."
                  )

                year = today.year
                month = today.strftime("%b")

                if ftype == "day":
                  period = f"{today.day}_day"
                elif ftype == "week":
                  period = f"{(today.day - 1)//5 + 1}_week"
                elif ftype == "month":
                  period = f"{today.month}_month"
                else:
                  period = "1_year"

                key = f"{year}_{period}_{month}"
                if key in periods_seen:
                  fail(f"❌ DUPLICATE TIME PERIOD\n\nFolder: {folder}\nPeriod: {key}")
                periods_seen.add(key)

                new_name = f"{next_serial} {year} {period} {month}.csv"

              else:
                # INVALID FORMAT
                if not re.match(r"(\\d{4}|\\d+\\s\\d{4})", f):
                  fail(
                    f"❌ INVALID FILE FORMAT\n\n"
                    f"Folder: {folder}\n"
                    f"File: {f}"
                  )

                if re.match(r"\\d+\\s\\d{4}", f):
                  continue  # already valid

                year, rest = f.split(" ", 1)
                new_name = f"{next_serial} {year} {rest}"

              if os.path.exists(os.path.join(path, new_name)):
                fail(
                  f"❌ DUPLICATE FINAL NAME\n\n"
                  f"Folder: {folder}\n"
                  f"File: {new_name}"
                )

              os.rename(full, os.path.join(path, new_name))
              renamed.append(f"{folder}/{new_name}")
              next_serial += 1

          if renamed:
            subprocess.run(["git", "add", "-A"])
            msg = ", ".join(renamed)
            subprocess.run([
              "git", "commit",
              "-m", f"{msg} + Updated + {today.strftime('%d/%m/%Y')}"
            ])
            subprocess.run(["git", "push"])

            requests.post(
              os.environ["TELEGRAM_API"] + os.environ["TELEGRAM_BOT_TOKEN"] + "/sendMessage",
              data={
                "chat_id": os.environ["TELEGRAM_CHAT_ID"],
                "text": (
                  "✅ COMMIT SUCCESSFUL\n\n"
                  f"Date: {date_str}\n\n"
                  "Files renamed & serial numbers assigned:\n" +
                  "\n".join(renamed)
                )
              }
            )
          EOF
