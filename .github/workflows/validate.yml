name: FunStock Validator

on:
  push:
    branches:
      - "**"

jobs:
  validate:
    runs-on: ubuntu-latest

    env:
      TARGET_FOLDERS: "daily weekly monthly yearly"
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
      TELEGRAM_API:       ${{ secrets.TELEGRAM_API }}

    steps:

      # ---------------------------------------------------------
      # 1) CHECKOUT CODE
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # ---------------------------------------------------------
      # 2) DETECT CHANGES (Works for Web commit, CLI commit, First commit)
      # ---------------------------------------------------------
      - name: Detect changes in target folders
        id: changes
        run: |
          # Universal safe diff for all commit types
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          else
            CHANGED_FILES=$(git diff --name-only --cached)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          SHOULD_RUN="false"
          for folder in $TARGET_FOLDERS; do
            if echo "$CHANGED_FILES" | grep -q "^${folder}/"; then
              SHOULD_RUN="true"
              break
            fi
          done

          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      # 3) SKIP IF NO TARGET FOLDER MODIFIED
      # ---------------------------------------------------------
      - name: Skip validation
        if: steps.changes.outputs.should_run == 'false'
        run: |
          echo "No daily/weekly/monthly/yearly folder changes — skipping validation."

      # ---------------------------------------------------------
      # 4) CHECK IF ANY PR EXISTS FOR THIS BRANCH
      # ---------------------------------------------------------
      - name: Check PR existence
        id: prcheck
        if: steps.changes.outputs.should_run == 'true'
        run: |
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"

          RESPONSE=$(curl -sS \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/pulls?state=open&base=$BRANCH")

          if [[ "$RESPONSE" != "[]" ]]; then
            echo "has_pr=true" >> $GITHUB_OUTPUT
          else
            echo "has_pr=false" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------------------------------
      # 5) PR EXISTS → REJECT COMMIT + TELEGRAM ALERT
      # ---------------------------------------------------------
      - name: Telegram — PR exists
        if: steps.changes.outputs.should_run == 'true' && steps.prcheck.outputs.has_pr == 'true'
        run: |
          MSG="❌ Commit rejected — Existing PR found for folder updates."
          curl -s -X POST "$TELEGRAM_API$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MSG"
          exit 1

      # ---------------------------------------------------------
      # 6) SETUP JAVA
      # ---------------------------------------------------------
      - name: Set up Java
        if: steps.changes.outputs.should_run == 'true' && steps.prcheck.outputs.has_pr == 'false'
        uses: actions/setup-java@v3
        with:
          java-version: "17"

      # ---------------------------------------------------------
      # 7) BUILD JAVA VALIDATOR
      # ---------------------------------------------------------
      - name: Build validator
        if: steps.changes.outputs.should_run == 'true' && steps.prcheck.outputs.has_pr == 'false'
        working-directory: ./funstock-validator
        run: mvn -q -DskipTests package

      # ---------------------------------------------------------
      # 8) RUN JAVA VALIDATOR
      # ---------------------------------------------------------
      - name: Run validator
        if: steps.changes.outputs.should_run == 'true' && steps.prcheck.outputs.has_pr == 'false'
        id: validate
        working-directory: ./funstock-validator
        run: |
          set +e
          java -cp target/funstock-validator-1.0-SNAPSHOT.jar com.fsm.validator.Main \
            > validator.log 2>&1
          EXIT_CODE=$?
          
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "log<<EOF" >> $GITHUB_OUTPUT
          cat validator.log >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          exit 0

      # ---------------------------------------------------------
      # 9) VALIDATION FAILED → TELEGRAM ALERT + REJECT
      # ---------------------------------------------------------
      - name: Telegram — Validation failed
        if: steps.changes.outputs.should_run == 'true'
            && steps.prcheck.outputs.has_pr == 'false'
            && steps.validate.outputs.exit_code != '0'
        run: |
          ERR=$(echo "${{ steps.validate.outputs.log }}" | head -n 1)
          MSG="❌ Commit rejected — Validation failed: $ERR"
          curl -s -X POST "$TELEGRAM_API$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MSG"
          exit 1

      # ---------------------------------------------------------
      # 10) VALIDATION SUCCESS → TELEGRAM ALERT
      # ---------------------------------------------------------
      - name: Telegram — Validation success
        if: steps.changes.outputs.should_run == 'true'
            && steps.prcheck.outputs.has_pr == 'false'
            && steps.validate.outputs.exit_code == '0'
        run: |
          FILES=$(git diff --name-only HEAD~1 HEAD | paste -sd "," -)
          MSG="✅ Validation success — Files updated successfully: $FILES"
          curl -s -X POST "$TELEGRAM_API$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MSG"

      # ---------------------------------------------------------
      # 11) AUTO-COMMIT RENAMED FILES
      # ---------------------------------------------------------
      - name: Auto-commit renamed files
        if: steps.changes.outputs.should_run == 'true'
            && steps.prcheck.outputs.has_pr == 'false'
            && steps.validate.outputs.exit_code == '0'
        run: |
          git config user.email "github-actions@github.com"
          git config user.name  "GitHub Actions Bot"

          git add -A

          if git diff-index --quiet HEAD; then
            echo "No renamed files to commit."
          else
            DATE=$(date +"%d/%m/%Y")
            FILES=$(git diff --name-only --cached | paste -sd "," -)
            MSG="$FILES + Updated + $DATE"
            git commit -m "$MSG"
            git push
          fi