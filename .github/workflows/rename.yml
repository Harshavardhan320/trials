name: Commit Engine File Rename

on:
  push:
    branches: ["**"]

jobs:
  rename:
    runs-on: ubuntu-latest

    permissions:
      contents: write   # REQUIRED for pushing renamed files

    steps:
      # ---------------------------------------------------------
      # 1) CHECKOUT CODE
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------------------------------
      # 2) RENAME + VALIDATE + COMMIT
      # ---------------------------------------------------------
      - name: Rename and validate CSV files
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python3 << 'EOF'
          import os, re, sys, datetime, subprocess, requests

          ROOT = os.getcwd()
          today = datetime.date.today()
          now = datetime.datetime.now().strftime("%d-%b-%Y %I:%M %p IST")
          weekday = today.weekday()  # Mon=0

          folders = {
              "dailyPerformance": "day",
              "weeklyPerformance": "week",
              "monthlyPerformance": "month",
              "yearlyPerformance": "year"
          }

          renamed = []

          # -----------------------------------------------------
          # TELEGRAM SEND
          # -----------------------------------------------------
          def send(msg):
              requests.post(
                  os.environ["TELEGRAM_API"]
                  + os.environ["TELEGRAM_BOT_TOKEN"]
                  + "/sendMessage",
                  data={
                      "chat_id": os.environ["TELEGRAM_CHAT_ID"],
                      "text": msg
                  }
              )

          # -----------------------------------------------------
          # FAIL (REJECT COMMIT)
          # -----------------------------------------------------
          def fail(folder, file, reason):
              send(
                  "Subject: ‚ùå Commit Rejected ‚Äì Validation Failed\n\n"
                  "Hello Team,\n\n"
                  "The commit operation has been rejected due to a validation error.\n\n"
                  f"üìÖ Date       : {now.split()[0]}\n"
                  f"‚è∞ Time       : {' '.join(now.split()[1:])}\n"
                  f"üìÅ Folder     : {folder}\n"
                  f"üìÑ File       : {file}\n\n"
                  f"‚ùó Reason:\n{reason}\n\n"
                  "Please correct the issue and retry the commit.\n\n"
                  "Regards,\nCommit Engine Automation"
              )
              sys.exit(1)

          # -----------------------------------------------------
          # PROCESS EACH FOLDER
          # -----------------------------------------------------
          for folder, ftype in folders.items():
              path = os.path.join(ROOT, folder)
              if not os.path.isdir(path):
                  continue

              files = [f for f in os.listdir(path) if f.lower().endswith(".csv")]

              # Find highest SERIAL (only valid serial files)
              serials = []
              for f in files:
                  m = re.match(r"^(\d+)\s\d{4}\s", f)
                  if m:
                      serials.append(int(m.group(1)))

              next_serial = max(serials, default=0) + 1
              periods_seen = set()

              for f in files:
                  full = os.path.join(path, f)

                  # ---------------- HOLDINGS ----------------
                  if f.lower() == "holdings.csv":

                      if ftype == "day" and weekday >= 5:
                          fail(folder, f, "Daily holdings upload is not allowed on weekends.")

                      year = today.year
                      month = today.strftime("%b")

                      if ftype == "day":
                          period = f"{today.day}_day"
                      elif ftype == "week":
                          period = f"{(today.day - 1)//5 + 1}_week"
                      elif ftype == "month":
                          period = f"{today.month}_month"
                      else:
                          period = "1_year"

                  # ---------------- MISSING FILE ----------------
                  elif re.match(r"^\d{4}\s\d+_(day|week|month|year)\s[a-zA-Z]+\.csv$", f):
                      year, period, month = f.replace(".csv", "").split()

                  # ---------------- ALREADY VALID ----------------
                  elif re.match(r"^\d+\s\d{4}\s\d+_(day|week|month|year)\s[a-zA-Z]+\.csv$", f):
                      continue

                  # ---------------- INVALID ----------------
                  else:
                      fail(folder, f, "Invalid filename format.")

                  # Duplicate time-period check
                  key = f"{year}_{period}_{month}"
                  if key in periods_seen:
                      fail(folder, f, "Duplicate time period detected.")
                  periods_seen.add(key)

                  # Build final name
                  new_name = f"{next_serial} {year} {period} {month}.csv"
                  new_path = os.path.join(path, new_name)

                  if os.path.exists(new_path):
                      fail(folder, new_name, "Final filename already exists.")

                  os.rename(full, new_path)
                  renamed.append(f"{folder}/{new_name}")
                  next_serial += 1

          # -----------------------------------------------------
          # IF NOTHING RENAMED ‚Üí EXIT
          # -----------------------------------------------------
          if not renamed:
              sys.exit(0)

          # -----------------------------------------------------
          # COMMIT & PUSH
          # -----------------------------------------------------
          subprocess.run(["git", "config", "user.name", "GitHub Actions"], check=True)
          subprocess.run(["git", "config", "user.email", "actions@github.com"], check=True)
          subprocess.run(["git", "add", "-A"], check=True)

          commit_msg = f"{', '.join(renamed)} + Updated + {today.strftime('%d/%m/%Y')}"
          subprocess.run(["git", "commit", "-m", commit_msg], check=True)
          subprocess.run(["git", "push"], check=True)

          # -----------------------------------------------------
          # SUCCESS TELEGRAM MESSAGE
          # -----------------------------------------------------
          folders_used = sorted(set(f.split("/")[0] for f in renamed))

          send(
              "Subject: ‚úÖ Commit Successful ‚Äì File Renaming Completed\n\n"
              "Hello Team,\n\n"
              "The commit operation has been completed successfully.\n\n"
              f"üìÖ Date       : {now.split()[0]}\n"
              f"‚è∞ Time       : {' '.join(now.split()[1:])}\n"
              f"üìÅ Folder(s)  : {', '.join(folders_used)}\n"
              "üîß Action     : File renaming and serial number assignment\n\n"
              "üìÑ Files Processed:\n"
              + "\n".join(f"- {f}" for f in renamed) +
              "\n\nRegards,\nCommit Engine Automation"
          )
          EOF
